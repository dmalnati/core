<html>
    <head>
        <title>RDVP Server</title>

        <style>
table, tr, th, td {
    border-collapse: collapse;
}
        </style>

        <script>
var wsAC = null;

function OnLoad()
{
    document.getElementById("dialogLogIn").showModal()
}

function DialogLogInOnKeyDown(event)
{
    var keyCodeEnter = 13;

    if (event.keyCode == keyCodeEnter)
    {
        var domClientId = document.getElementById("clientId");
        var domPassword = document.getElementById("password");

        document.getElementById("dialogLogInSubmit").click()
    }
}

function DialogLogInOnSubmit()
{
    var url = window.location.href;
    var arr = url.split("/");
    var hostAndPort = arr[2];
                    
    clientId = document.getElementById("clientId").value
    password = document.getElementById("password").value

    document.getElementById("dialogLogIn").close()

    wsAC = new WebSocket("ws://" + hostAndPort + "/ws");

    wsAC.onopen = function(event)
    {
        Log("onopen");

        wsAC.send(JSON.stringify({
            "MESSAGE_TYPE" : "REQ_LOGIN_AC",
            "ID"           : clientId,
            "PASSWORD"     : password
        }));
    }

    wsAC.onmessage = function(event)
    {
        Log("AC onmessage (" + event.data + ")")
        OnAdminMessage(event.data)
    }

    wsAC.onclose = function(event)
    {
        Log("onclose")
    }

    wsAC.onerror = function(event)
    {
        Log("onerror")
    }
}

function OnAdminMessage(msg)
{
    jsonObj = JSON.parse(msg)

    scList     = jsonObj["SC_LIST"]
    ccList     = jsonObj["CC_LIST"]
    acList     = jsonObj["AC_LIST"]
    bridgeList = jsonObj["CCSC_BRIDGE_LIST"]

    PopulateContainerSC("scList", scList)
    PopulateContainer("ccList", ccList)
    PopulateContainer("acList", acList)
    PopulateContainer("bridgeList", bridgeList)
}

function PopulateContainer(id, valList)
{
    domContainer = document.getElementById(id)

    domContainer.innerHTML = ""

    for (i = 0; i < valList.length; ++i)
    {
        domContainer.innerHTML += valList[i] + "<br/>"
    }
}

function ConnectToSc(scId, clientId, password)
{
    Log("ConnectToSc")

    var url = window.location.href;
    var arr = url.split("/");
    var hostAndPort = arr[2];
    ws = new WebSocket("ws://" + hostAndPort + "/ws");

    var domDialog = document.getElementById("scInterface")
    var domScTo   = document.getElementById("scTo")
    var domScFrom = document.getElementById("scFrom")
    var domScSend = document.getElementById("scSend")
    var domScClose = document.getElementById("scClose")
    var domScStatus = document.getElementById("scStatus")

    // Set up dialog values
    domScTo.value = ""
    domScFrom.value = ""
    domScStatus.innerHTML = "Connecting..."

    domScTo.onkeydown = function(event)
    {
        var keyCodeEnter = 13;

        if (event.keyCode == keyCodeEnter)
        {
            domScSend.onclick()
        }
    }

    domScClose.onclick = function()
    {
        ws.close()
        domDialog.close()
    }

    domScSend.onclick = function()
    {
        ws.send(domScTo.value)
        Log("sending: " + domScTo.value)
        domScTo.value = ""
    }

    domScStatus.onclick = function()
    {
        Log("one")
    }


    // Set up callbacks
    ws.onopen = function(event)
    {
        ws.send(JSON.stringify({
            "MESSAGE_TYPE"  : "REQ_LOGIN_CC",
            "ID"            : clientId,
            "PASSWORD"      : password,
            "CONNECT_TO_ID" : scId
        }));

        domScStatus.innerHTML = "Connected"
    }

    ws.onmessage = function(event)
    {
        Log("SC: onmessage(" + event.data + ")")
        domScFrom.value += event.data + "\n"
    }

    ws.onclose = function(event)
    {
        domScStatus.innerHTML = "Closed"
    }

    ws.onerror = function(event)
    {
        domScStatus.innerHTML = "ERROR"
    }

    // Show dialog
    //domDialog.showModal()
    // if you use this, the handles above don't work correctly, seemingly
    // in the circumstance where the non-modal content changes.
    // EG if the main page changes (as a result of the AC socket getting
    // updates, then seemingly it all goes haywire.
    // Some kind of bug?

    domDialog.show()
}

function PopulateContainerSC(id, valList)
{
    domContainer = document.getElementById(id)

    domContainer.innerHTML = ""

    for (i = 0; i < valList.length; ++i)
    {
        domContainer.innerHTML +=
            "<span onclick='ConnectToSc(\"" + valList[i] + "\",\"pi2\",\"\");'>" + valList[i] + "</span>" + "<br/>"
    }
}

function Log(str)
{
    //document.body.innerHTML += str + "<br/>";
}
        </script>
    </head>

    <body onload='OnLoad();'>

        <table border=1>
            <tr>
                <th>SC</th>
                <th>CC</th>
                <th>AC</th>
                <th>Bridge</th>
            </tr>
            <tr>
                <td><div id='scList'></div></td>
                <td><div id='ccList'></div></td>
                <td><div id='acList'></div></td>
                <td><div id='bridgeList'></div></td>
            </tr>
        </table>








        <dialog id='dialogLogIn'>
            <input type='text' id='clientId' placeholder='clientId' onkeydown='DialogLogInOnKeyDown(event);'>
            <br/>
            <input type='text' id='password' placeholder='password' onkeydown='DialogLogInOnKeyDown(event);'>
            <br/>
            <input type='button' value='Log In' id='dialogLogInSubmit' onclick='DialogLogInOnSubmit();'>
        </dialog>

        <dialog id='scInterface'>
            <input id='scTo' style='width: 100%;'><br/>
            <textarea id='scFrom' rows='10' style='width: 100%;'></textarea><br/>
            <input type=button id='scSend' value='send'><br/>
            <input type=button id='scClose' value='close'><br/>
            <div id='scStatus'></div>
        </dialog>

    </body>
</html>









