<!DOCTYPE html>
<html>
    <head>


<!--
https://developer.mozilla.org/en-US/docs/Mozilla/Mobile/Viewport_meta_tag
-->
        <meta name="viewport" content="width=device-width, initial-scale=4">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="manifest" href="manifest.json">

        <style>
body {
    background-color: black;
    color: white;
}
        </style>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <script>
function OnLoad()
{
    // setup
    UpdatePageState();
}

function ToggleAllLamps()
{
    let cb1 = document.getElementById("CB_PS1");
    let cb2 = document.getElementById("CB_PS2");
    let cb4 = document.getElementById("CB_PS4");

    let c1 = cb1.checked;
    let c2 = cb2.checked;
    let c4 = cb4.checked;

    // if any are checked, then shut them all off.
    // if all are unchecked, turn them all on.
    if (c1 || c2 || c4)
    {
        if (c1) { cb1.click(); }
        if (c2) { cb2.click(); }
        if (c4) { cb4.click(); }
    }
    else
    {
        cb1.click();
        cb2.click();
        cb4.click();
    }
}

function UpdatePageState()
{
    // purposefully sequential async
    new Promise(function(resolve, reject) {
        GetAndSetCheckbox("CB_AC1", function() { resolve(); });
    }).then(function(data) {
        return new Promise(function(resolve, reject) {
            GetAndSetCheckbox("CB_AC2", function() { resolve(); });
        });
    }).then(function(data) {
        return new Promise(function(resolve, reject) {
            GetAndSetCheckbox("CB_PS1", function() { resolve(); });
        });
    }).then(function(data) {
        return new Promise(function(resolve, reject) {
            GetAndSetCheckbox("CB_PS2", function() { resolve(); });
        });
    }).then(function(data) {
        return new Promise(function(resolve, reject) {
            GetAndSetCheckbox("CB_PS4", function() { resolve(); });
        });
    }).then(function(data) {
        setTimeout(UpdatePageState, 5000);
    });
}


function GetBaseURL()
{
    let url = window.location.href
    let arr = url.split("/");
    let result = arr[0] + "//" + arr[2]

    return result;
}

function GetGetURL(getName)
{
    return GetBaseURL() + "/" + "get/?name=" + getName;
}

function GetSetURL(setName, setValue)
{
    return GetBaseURL() + "/" + "set/?name=" + setName + "&value=" + setValue;
}

//
// cb - callback: fn(ok, onOffStatus)
//
function GetDeviceOnOffStatus(deviceName, cb)
{
    let url = GetGetURL(deviceName);

    $.ajax({
        url: url,
        success: function(result, status, xhr) { cb(1, parseInt(result)); },
        error:   function(xhr, status, error)  { cb(0, 0);     }
    });
}

//
// cb - callback: fn(ok)
//
function SetDeviceOnOffStatus(deviceName, deviceValue, cb)
{
    let url = GetSetURL(deviceName, deviceValue);

    $.ajax({
        url: url,
        success: function(result, status, xhr) { cb(1); },
        error:   function(xhr, status, error)  { cb(0); }
    });
}

function GetAndSetCheckbox(id, cb = function(){})
{
    let domEl = document.getElementById(id);

    if (domEl)
    {
        // grey out
        //domEl.disabled = true;

        let deviceName = domEl.getAttribute("data-device-name");

        GetDeviceOnOffStatus(deviceName, function(ok, onOffStatus) {
            if (ok)
            {
                //console.log(deviceName + " = " + onOffStatus);

                if (onOffStatus)
                {
                    domEl.checked = true;
                }
                else
                {
                    domEl.checked = false;
                }

                domEl.disabled = false;
            }
            else
            {
                console.log("Could not get status for " + deviceName);
                domEl.disabled = true;
            }

            // re-enable
            //domEl.disabled = false;

            // indicate operation complete
            cb();
        });
    }
}

function ToggleCheckbox(domEl)
{
    // grey out
    //domEl.disabled = true;

    let deviceName  = domEl.getAttribute("data-device-name");
    // value will have already been changed on the page, but we want to
    // actually set it on the server-side, so look at its current value to
    // know what to try to set it to
    let deviceValue = domEl.checked ? 1 : 0;

    //console.log("reading checked = " + domEl.checked);
    console.log("setting " + deviceName + " = " + deviceValue);

    SetDeviceOnOffStatus(deviceName, deviceValue, function(ok) {
        GetAndSetCheckbox(domEl.id);

        // re-enable
        //domEl.disabled = false;
    });

    return false;
}



        </script>
    </head>

    <body onload='OnLoad();'>
<div>
AC1: <input type='checkbox'
            id='CB_AC1'
            onclick='ToggleCheckbox(this)'
            data-device-name='AC1'>
</div>

<div>
AC2: <input type='checkbox'
            id='CB_AC2'
            onclick='ToggleCheckbox(this)'
            data-device-name='AC2'>
</div>

<br/>
<div style='user-select: none;' onclick='ToggleAllLamps();'>
Lamps:
</div>
<table>
    <tr>
        <td>
            <input type='checkbox'
                   id='CB_PS1'
                   onclick='ToggleCheckbox(this)'
                   data-device-name='PS1'>
        </td>
        <td>
            <input type='checkbox'
                   id='CB_PS2'
                   onclick='ToggleCheckbox(this)'
                   data-device-name='PS2'>
        </td>
        <td>
            <input type='checkbox'
                   id='CB_PS4'
                   onclick='ToggleCheckbox(this)'
                   data-device-name='PS4'>
        </td>
    </tr>
</table>

    </body>
</html>













