<html>
    <head>
        <title>UV4L Interface</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <style>
table, tr, th, td {
    border-collapse: collapse;
}

button {
    width: 55px;
    height: 55px;
}
        </style>

        <!-- THREE.js libs:
             - three.js - core
             - DeviceOrientationControls - help mapping device to camera dir
             - StereoEffect - cardboard stuff
        -->
        <script src="js/third-party/threejs.r73/three.js"></script>
        <script src="js/third-party/threejs.r73/DeviceOrientationControls.js">
        </script>
        <script src="js/third-party/threejs.r73/StereoEffect.js">
        </script>

        <script src="js/orientation.js"></script>
        <script src="js/cardboard.js"></script>

        <script src='js/rdvp.js'></script>
        <script src='js/webrtc.js'></script>

        <script>


function PlaceStream(stream)
{
    domVideo = document.getElementById("videoRTC");

    domVideo.autoplay = true;
    domVideo.controls = true;
    domVideo.muted    = true;

    domVideo.src = URL.createObjectURL(stream);
}


function OnWebRTCStream(stream)
{
    console.log("OnWebRTCStream");
    PlaceStream(stream);
}

function OnWebRTCStreamEnd()
{
    document.getElementById("videoRTC").pause();
}

function OnClickConnectRTC()
{
    OnStartWebRTC(
        document.getElementById("clientIdWebRTC").value,
        document.getElementById("connectToIdWebRTC").value,
        document.getElementById("passwordWebRTC").value,
        function OnOpen() {
            document.getElementById("rtcStatus").style.backgroundColor = "green";
        }, function OnClose() {
            document.getElementById("rtcStatus").style.backgroundColor = "red";
        }
    );
}

function OnClickConnectServo()
{
    OnStartServo(
        document.getElementById("clientIdServo").value,
        document.getElementById("connectToIdServo").value,
        document.getElementById("passwordServo").value,
        function OnOpen(ws) {
            document.getElementById("servoStatus").style.backgroundColor = "green";
        }, function OnClose() {
            document.getElementById("servoStatus").style.backgroundColor = "red";
        }
    );
}


var servoButtonsActive = false;
function ActivateServoButtons()
{
    servoButtonsActive = true;

    document.getElementById("buttonBorder").style.borderColor = "green";
}

function DeactivateServoButtons()
{
    servoButtonsActive = false;

    document.getElementById("buttonBorder").style.borderColor = "red";
}

var wsServo = null;
function OnStartServo(clientId, connectToId, password, cbOpen, cbClose)
{
    ws = RDVP_WebSocketThisHost("CC", clientId, password, connectToId);
    ws.onopen = function() {
        cbOpen();
    }

    ws.onclose = function() {
        cbClose();
    }

    wsServo = ws;
}

var wsWebRTC = null;
var wrtcr = null;
function OnStartWebRTC(clientId, connectToId, password, cbOpen, cbClose)
{

    navigator.getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia;

    var constraints = {
        audio: true,
        video: true
    };

//    navigator.getUserMedia(
//        constraints,
//        function OnSuccess(streamLocal) {
            ws = RDVP_WebSocketThisHost("CC", clientId, password, connectToId);

            streamLocal = null;

            ws.onopen = function() {
                wrtcr = WebRTC_Receiver(ws, streamLocal, {
                    OnStreamAdded: function(stream) {
                        OnWebRTCStream(stream);
                    },

                    OnStreamRemoved: function() {
                        OnWebRTCStreamEnd();

                        cbClose()
                    }
                });

                cbOpen();
            }

            wsWebRTC = ws;
//        }, function OnFailure(err) {
//            console.log("ERR: Could not get user media: " + err);
//        }
//    );
}

function OnClickDisconnectRTC()
{
    if (wsWebRTC) { wsWebRTC.close(); }

    OnWebRTCStreamEnd();
}

function OnClickDisconnectServo()
{
    if (wsServo) { wsServo.close(); }
}



function GetRadioButtonVal(name)
{
    domElList = document.getElementsByName(name);

    for (var i = 0; i < domElList.length; ++i)
    {
        if (domElList[i].checked)
        {
            return domElList[i].value;
        }
    }
}


var pubLast = 0;
function PublishToServo(val, domId)
{
    val = val.toFixed(1);

    if (pubLast)
    {
        if (Math.abs(val - pubLast) >= 0.5)
        {
            wsServo.send(val);

            pubLast = val;
        }
        else
        {
            console.log("discarded " + val.toFixed(1) + ", same as before");
        }
    }
    else
    {
        pubLast = val;
    }
}


function ResetOrientationOffset()
{
    changeObjRef = changeObjNew;
}

var changeObjRef = null;
var changeObjNew = null;
function SetUpOrientationHandler()
{
    var oh = new OrientationHelper(function(changeObj) {
        changeObjNew = changeObj;

        var offset = 0;

        var firstTimeSinceReset = false;

        if (changeObjRef != null)
        {
            // map 360 degree val to -90 - 90
            offset = changeObjRef.degRotation - changeObj.degRotation;

            // limit range
            if (offset > 90)
            {
                offset = 90;
            }
            else if (offset < -90)
            {
                offset = -90;
            }
        }
        else
        {
            changeObjRef = changeObj;

            firstTimeSinceReset = true;
        }

        if (wsServo &&
            !firstTimeSinceReset &&
            GetRadioButtonVal("ctlType") == "orientation")
        {
            PublishToServo(offset, "orientationValSent");
        }

        document.getElementById("orientationVal").innerHTML =
            "raw: " + changeObj.degRotation + "<br/>" +
            "offset: " + offset;
    });
}

function OnRangeVal(val)
{
    if (wsServo && GetRadioButtonVal("ctlType") == "range")
    {
        PublishToServo(-val, "rangeValSent");
    }

    document.getElementById("rangeVal").innerHTML = -val;
}


function OnClickGetUserMedia()
{
    navigator.getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia;

    navigator.getUserMedia(
        {
            audio: false,
            video: true
        },
        function OnSuccess(mediaStream) {
            PlaceStream(mediaStream);
        }, function OnFailure(err) {
            console.log("Couldn't get local media stream: " + err);
        }
    );
}



function OnLoad()
{
    var domVideo = document.getElementById("videoRTC");

    domVideo.onresize = function() {
        console.log("size changed: " + domVideo.videoWidth + "x" + domVideo.videoHeight);
    }

    SetUpOrientationHandler();
    Cardboard(domVideo);
}


        </script>
    </head>

    <body onload='OnLoad();'>


        <table border=1>
            <tr>
                <th>Ctl</th>
                <th>ID</th>
                <th>Service</th>
                <th>PW</th>
                <th>Action</th>
                <th>Status</th>
            </tr>
            <tr>
                <td>WebRTC</td>
                <td>
        <input id='clientIdWebRTC' value='OP1' size='8'>
                </td>
                <td>
        <input id='connectToIdWebRTC' value='UV4L' size='8'>
                </td>
                <td>
        <input id='passwordWebRTC' value='' size='8'>
                </td>
                <td>
        <input type='button' value='connect' onclick='OnClickConnectRTC()'>
        <input type='button' value='disconnect' onclick='OnClickDisconnectRTC()'>
                </td>
                <td id='rtcStatus' style='background-color: red;'>
                </td>
            </tr>
            <tr>
                <td>Servo</td>
                <td>
        <input id='clientIdServo' value='OP2' size='8'>
                </td>
                <td>
        <input id='connectToIdServo' value='SERVO' size='8'>
                </td>
                <td>
        <input id='passwordServo' value='' size='8'>
                </td>
                <td>
        <input type='button' value='connect' onclick='OnClickConnectServo()'>
        <input type='button' value='disconnect' onclick='OnClickDisconnectServo()'>
                </td>
                <td id='servoStatus' style='background-color: red;'>
                </td>
            </tr>
        </table>

        <input type='button'
               value='getUserMedia'
               onclick='OnClickGetUserMedia()'>

        <br/>

        <style>
/*

I've seen the streaming video at resolutions:
- 640x480 (WebRTC, getUserMedia)
- 480x360 (WebRTC)
- 320x240 (WebRTC)

And it changes during playback from WebRTC streams.

}

 */

#videoRTC {
    width: 320px;
    height: 240px;
}

        </style>
        <div id='remoteStreamContainer'>
            <video id='videoRTC'></video>
        </div>

        <br/>

        Camera Control
        <table border=1>
            <tr>
                <th>use</th>
                <th>input</th>
                <th>value</th>
                <th>sent</th>
            </tr>
            <tr>
                <td><input type='radio' name='ctlType' value='orientation'></input></td>
                <td>
                orientation
                <button onclick='ResetOrientationOffset();'>set origin</button>
                </td>
                <td><div id='orientationVal'>0</div></td>
                <td><div id='orientationValSent'>0</div></td>
            </tr>
            <tr>
                <td><input type='radio' name='ctlType' value='range' checked></input></td>
                <td>
                    <input type='range' min='-90' max='90' step='1' value='0'
                           oninput='OnRangeVal(this.value);'
                           ></input>
                </td>
                <td><div id='rangeVal'>0</div></td>
                <td><div id='rangeValSent'>0</div></td>
            </tr>
        </table>

        <br/>
        <br/>

        Cardboard View (latest 3)<br/>
<style>

#restrainer {
    width: 480;
    height: 240;
}

#cardboardContainer {
    height: 100%;
    width: 100%;
}

</style>
        <div id='restrainer'>
            <div id='cardboardContainer'>
            </div>
        </div>


        <br/>
        <br/>
        <br/>
        <br/>

    </body>
</html>









