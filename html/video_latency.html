<html>
    <head>
        <title>Video Latency</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <script src='js/graph.js'></script>
		<script src='js/video.js'></script>
		
        <script src='js/rdvp.js'></script>
        <script src='js/webrtc.js'></script>

        <style>
table, tr, th, td {
    border-collapse: collapse;
}

video {
	height: 240px;
	width: 320px;
}

#container {
    width: 80%;
    height: 1000px;
    border: 1px solid red;
}
        </style>



        <script>

		
		
		
/////////////////////////////////////////////////////
//
// Video Observation Logic
//
/////////////////////////////////////////////////////

function TimeNow()
{
	return (new Date()).getTime();
}

function BeginMonitoringVideo()
{
	var domVideo = document.getElementById("video");
	
	// Set up event handlers
	
	
	
	var vo = new VideoObserver(document.getElementById("container"),
	                           domVideo);
	vo.Start();
	
	return;
	
	
	// Set up function to watch the stream over time
	var timeLast = TimeNow();
	var currentTimeLast = domVideo.currentTime;
	var fnTimeout = function()
	{
		// Figure out how much time has actually gone by
		var timeNow = TimeNow();
		var msDiff = timeNow - timeLast;
		timeLast = timeNow;
		
		// Observe the actual state of the video playback
		
		// How many frames (or amount of playback) has occurred?
		var currentTime = domVideo.currentTime;
		var currentTimeDiff = currentTime - currentTimeLast;
		currentTimeLast = currentTime;
		
		chartTs.AddSample(timeNow, currentTimeDiff);
		
		setTimeout(fnTimeout, 1000)
	}
	
	setTimeout(fnTimeout, 1000);
}



/////////////////////////////////////////////////////
//
// Video Display and Monitoring
//
/////////////////////////////////////////////////////

function ShowAndMonitorStream(mediaStream)
{
	domVideo = document.getElementById("video");
	domVideo.autoplay = true;
	domVideo.controls = true;
	domVideo.muted    = true;

	domVideo.src = URL.createObjectURL(mediaStream);
	
	BeginMonitoringVideo();
}

/////////////////////////////////////////////////////
//
// Local Video
//
/////////////////////////////////////////////////////

function OnClickGetUserMedia()
{
    navigator.getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia;

    navigator.getUserMedia(
        {
            audio: false,
            video: true
        },
        function OnSuccess(mediaStream) {
			ShowAndMonitorStream(mediaStream)
        }, function OnFailure(err) {
            console.log("Couldn't get local media stream: " + err);
        }
    );
}


/////////////////////////////////////////////////////
//
// WebRTC
//
/////////////////////////////////////////////////////


function WebRTCStatusGreen()
{
	document.getElementById("rtcStatus").style.backgroundColor = "green";
}

function WebRTCStatusRed()
{
	document.getElementById("rtcStatus").style.backgroundColor = "red";
}

function OnClickConnectRTC()
{
    OnStartWebRTC(
        document.getElementById("clientIdWebRTC").value,
        document.getElementById("connectToIdWebRTC").value,
        document.getElementById("passwordWebRTC").value,
        function OnOpen() {
            WebRTCStatusGreen();
        }, function OnClose() {
            WebRTCStatusRed();
        }
    );
}

function OnClickDisconnectRTC()
{
    if (wsWebRTC) { wsWebRTC.close(); }
	
	WebRTCStatusRed();
}

var wsWebRTC = null;
var wrtcr = null;
function OnStartWebRTC(clientId, connectToId, password, cbOpen, cbClose)
{
    navigator.getUserMedia = navigator.getUserMedia ||
                             navigator.webkitGetUserMedia;

    var constraints = {
        audio: true,
        video: true
    };

	ws = RDVP_WebSocketThisHost("CC", clientId, password, connectToId);

	streamLocal = null;

	ws.onopen = function() {
		wrtcr = WebRTC_Receiver(ws, streamLocal, {
			OnStreamAdded: function(stream) {
				ShowAndMonitorStream(stream);
			},

			OnStreamRemoved: function() {
			}
		});

		cbOpen();
	}
	
	ws.onclose = function()
	{
		cbClose();
	}
	
	ws.onerror = function()
	{
		cbClose();
	}

	wsWebRTC = ws;
}



/////////////////////////////////////////////////////
//
// OnLoad
//
/////////////////////////////////////////////////////

function OnLoad()
{
}

        </script>

    </head>

    <body onload='OnLoad();'>

	
        <table border=1>
            <tr>
                <th>Ctl</th>
                <th>ID</th>
                <th>Service</th>
                <th>PW</th>
                <th>Action</th>
                <th>Status</th>
            </tr>
            <tr>
                <td>WebRTC</td>
                <td>
        <input id='clientIdWebRTC' value='CC_RTC' size='8'>
                </td>
                <td>
        <input id='connectToIdWebRTC' value='UV4L' size='8'>
                </td>
                <td>
        <input id='passwordWebRTC' value='' size='8'>
                </td>
                <td>
        <input type='button' value='connect' onclick='OnClickConnectRTC()'>
        <input type='button' value='disconnect' onclick='OnClickDisconnectRTC()'>
                </td>
                <td id='rtcStatus' style='background-color: red;'>
                </td>
            </tr>
        </table>			
	
	
		<input type='button'
			   value='getUserMedia'
			   onclick='OnClickGetUserMedia()'>
			   
		<br/>
		<br/>
	
        <button onclick='OnClickStart()'>Start</button>
        <button onclick='OnClickStop()'>Stop</button>
        <input type='number' id='msSampleInterval' min='1' value='1000' onchange='OnSampleIntervalChange()'> msSampleInterval

        <br/>
        <br/>
		
		<video id='video'></video>
		
        <br/>
        <br/>
		
		<div id='container'></div>

        <br/>
        <br/>
        <br/>
        <br/>
        <br/>

    </body>
</html>









