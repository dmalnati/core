<html>
    <head>
        <title>RDVP Server</title>

        <style>
table, tr, th, td {
    border-collapse: collapse;
}
        </style>

        <script src='rdvp.js'></script>

        <script>
var wsAC = null;

function OnLoad()
{
    document.getElementById("dialogLogIn").showModal()
}

function DialogLogInOnKeyDown(evt)
{
    var keyCodeEnter = 13;

    if (evt.keyCode == keyCodeEnter)
    {
        var domClientId = document.getElementById("clientId");
        var domPassword = document.getElementById("password");

        document.getElementById("dialogLogInSubmit").click()
    }
}

function DialogLogInOnSubmit()
{
    clientId = document.getElementById("clientId").value
    password = document.getElementById("password").value

    document.getElementById("dialogLogIn").close()

    wsAC = RDVP_WebSocketThisHost("AC", clientId, password);

    wsAC.onopen = function()
    {
        Log("onopen");
    }

    wsAC.onmessage = function(evt)
    {
        Log("AC onmessage (" + evt.data + ")")
        OnAdminMessage(evt.data)
    }

    wsAC.onclose = function(evt)
    {
        Log("onclose")
    }

    wsAC.onerror = function(evt)
    {
        Log("onerror")
    }
}

function OnAdminMessage(msg)
{
    jsonObj = JSON.parse(msg)

    scList     = jsonObj["SC_LIST"]
    ccList     = jsonObj["CC_LIST"]
    acList     = jsonObj["AC_LIST"]
    bridgeList = jsonObj["CCSC_BRIDGE_LIST"]

    PopulateContainerSC("scList", scList)
    PopulateContainer("ccList", ccList)
    PopulateContainer("acList", acList)
    PopulateContainer("bridgeList", bridgeList)
}

function PopulateContainer(id, valList)
{
    domContainer = document.getElementById(id)

    domContainer.innerHTML = ""

    for (i = 0; i < valList.length; ++i)
    {
        domContainer.innerHTML += valList[i] + "<br/>"
    }
}

function ConnectToSc(scId, clientId, password)
{
    Log("ConnectToSc")


    var domDialog = document.getElementById("scInterface")
    var domScTo   = document.getElementById("scTo")
    var domScFrom = document.getElementById("scFrom")
    var domScSend = document.getElementById("scSend")
    var domScClose = document.getElementById("scClose")
    var domScStatus = document.getElementById("scStatus")

    // Set up dialog values
    domScTo.value = ""
    domScFrom.value = ""
    domScStatus.innerHTML = "Connecting..."

    domScTo.onkeydown = function(evt)
    {
        var keyCodeEnter = 13;

        if (evt.keyCode == keyCodeEnter)
        {
            domScSend.onclick()
        }
    }

    domScClose.onclick = function()
    {
        ws.close()
        domDialog.close()
    }

    domScSend.onclick = function()
    {
        ws.send(domScTo.value)
        Log("sending: " + domScTo.value)
        domScTo.value = ""
    }

    domScStatus.onclick = function()
    {
        Log("one")
    }


    // Create websocket
    var ws = RDVP_WebSocketThisHost("CC", clientId, password, scId);

    // Set up callbacks
    ws.onopen = function(evt)
    {
        ws.send(JSON.stringify({
            "MESSAGE_TYPE"  : "REQ_LOGIN_CC",
            "ID"            : clientId,
            "PASSWORD"      : password,
            "CONNECT_TO_ID" : scId
        }));

        domScStatus.innerHTML = "Connected"
    }

    ws.onmessage = function(evt)
    {
        Log("SC: onmessage(" + evt.data + ")")
        domScFrom.value += evt.data + "\n"
    }

    ws.onclose = function(evt)
    {
        domScStatus.innerHTML = "Closed"
    }

    ws.onerror = function(evt)
    {
        domScStatus.innerHTML = "ERROR"
    }

    // Show dialog
    //domDialog.showModal()
    // if you use this, the handles above don't work correctly, seemingly
    // in the circumstance where the non-modal content changes.
    // EG if the main page changes (as a result of the AC socket getting
    // updates, then seemingly it all goes haywire.
    // Some kind of bug?

    domDialog.show()
}

function PopulateContainerSC(id, valList)
{
    domContainer = document.getElementById(id)

    domContainer.innerHTML = ""

    for (i = 0; i < valList.length; ++i)
    {
        domContainer.innerHTML +=
            "<span onclick='ConnectToSc(\"" + valList[i] + "\",\"pi2\",\"\");'>" + valList[i] + "</span>" + "<br/>"
    }
}

function Log(str)
{
    //document.body.innerHTML += str + "<br/>";
}
        </script>
    </head>

    <body onload='OnLoad();'>

        <table border=1>
            <tr>
                <th>SC</th>
                <th>CC</th>
                <th>AC</th>
                <th>Bridge</th>
            </tr>
            <tr>
                <td><div id='scList'></div></td>
                <td><div id='ccList'></div></td>
                <td><div id='acList'></div></td>
                <td><div id='bridgeList'></div></td>
            </tr>
        </table>








        <dialog id='dialogLogIn'>
            <input type='text'
                   id='clientId'
                   placeholder='clientId'
                   onkeydown='DialogLogInOnKeyDown(evt);'>
            <br/>
            <input type='text'
                   id='password'
                   placeholder='password'
                   onkeydown='DialogLogInOnKeyDown(evt);'>
            <br/>
            <input type='button'
                   value='Log In'
                   id='dialogLogInSubmit'
                   onclick='DialogLogInOnSubmit();'>
        </dialog>

        <dialog id='scInterface'>
            <input id='scTo' style='width: 100%;'><br/>
            <textarea id='scFrom' rows='10' style='width: 100%;'></textarea><br/>
            <input type=button id='scSend' value='send'><br/>
            <input type=button id='scClose' value='close'><br/>
            <div id='scStatus'></div>
        </dialog>

    </body>
</html>









